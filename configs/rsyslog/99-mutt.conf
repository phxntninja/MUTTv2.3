# =====================================================================
# MUTT v2.3 - rsyslog Configuration
# =====================================================================
# This file configures rsyslog to forward syslog and SNMP trap messages
# to the MUTT Ingestor service via HTTP POST with proper JSON formatting.
#
# Installation:
#   1. Copy to /etc/rsyslog.d/99-mutt.conf
#   2. Restart rsyslog: systemctl restart rsyslog
#
# Critical fixes from original version:
#   - Fixed JSON escaping (was: value=""timestamp":"", now: value="\"timestamp\":\"")
#   - Changed action type from omfwd to omhttp
#   - Enabled TLS (usehttps="on")
#   - Added batching for performance
#   - Fixed property references
# =====================================================================

# Load required modules
module(load="omhttp")

# =====================================================================
# JSON Template for Syslog Messages
# =====================================================================
template(name="mutt_json_syslog" type="list") {
    constant(value="{")
    constant(value="\"timestamp\":\"")
    property(name="timereported" dateFormat="rfc3339")
    constant(value="\",\"hostname\":\"")
    property(name="hostname")
    constant(value="\",\"severity\":\"")
    property(name="syslogseverity-text")
    constant(value="\",\"facility\":\"")
    property(name="syslogfacility-text")
    constant(value="\",\"message\":\"")
    property(name="msg" format="json")
    constant(value="\",\"source\":\"syslog\"")
    constant(value="}")
}

# =====================================================================
# JSON Template for SNMP Trap Messages (facility local5)
# =====================================================================
template(name="mutt_json_snmp" type="list") {
    constant(value="{")
    constant(value="\"timestamp\":\"")
    property(name="timereported" dateFormat="rfc3339")
    constant(value="\",\"hostname\":\"")
    property(name="hostname")
    constant(value="\",\"severity\":\"")
    property(name="syslogseverity-text")
    constant(value="\",\"facility\":\"")
    property(name="syslogfacility-text")
    constant(value="\",\"message\":\"")
    property(name="msg" format="json")
    constant(value="\",\"source\":\"snmp\"")
    constant(value="}")
}

# =====================================================================
# Action: Forward Syslog Messages to MUTT Ingestor
# =====================================================================
# All syslog messages EXCEPT facility local5 (which is SNMP traps)
if $syslogfacility-text != 'local5' then {
    action(
        type="omhttp"
        server="mutt-ingestor.yourdomain.com"
        serverport="8080"
        restpath="/ingest"
        template="mutt_json_syslog"

        # TLS Configuration
        usehttps="on"

        # Authentication
        httpheaders=["X-API-KEY: your-api-key-here"]

        # Performance
        batch="on"
        batch.maxsize="100"
        batch.timeout="1000"

        # Error Handling
        action.resumeRetryCount="-1"
        action.resumeInterval="10"

        # Queue
        queue.type="LinkedList"
        queue.size="10000"
        queue.dequeueBatchSize="100"
        queue.workerThreads="4"
    )
}

# =====================================================================
# Action: Forward SNMP Trap Messages to MUTT Ingestor
# =====================================================================
# Only facility local5 (SNMP traps from snmptrapd)
if $syslogfacility-text == 'local5' then {
    action(
        type="omhttp"
        server="mutt-ingestor.yourdomain.com"
        serverport="8080"
        restpath="/ingest"
        template="mutt_json_snmp"

        # TLS Configuration
        usehttps="on"

        # Authentication
        httpheaders=["X-API-KEY: your-api-key-here"]

        # Performance
        batch="on"
        batch.maxsize="100"
        batch.timeout="1000"

        # Error Handling
        action.resumeRetryCount="-1"
        action.resumeInterval="10"

        # Queue
        queue.type="LinkedList"
        queue.size="10000"
        queue.dequeueBatchSize="100"
        queue.workerThreads="4"
    )
}

# =====================================================================
# Configuration Notes
# =====================================================================
# - Replace "mutt-ingestor.yourdomain.com" with your actual hostname/IP
# - Replace "your-api-key-here" with the actual API key from Vault
# - Adjust queue sizes based on your message volume
# - For development, you can set usehttps="off" (NOT recommended for prod)
# - batch.maxsize controls how many messages are sent per HTTP request
# - queue.size limits how many messages can be buffered
# =====================================================================
