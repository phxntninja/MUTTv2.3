groups:
  - name: mutt-slo-recording-rules
    interval: 1m
    rules:
      # ================================================================
      # Ingestor SLO Recording Rules
      # ================================================================

      # Ingestor availability - success rate (Target: 99.9%)
      - record: mutt:slo:ingestor_availability:5m
        expr: |
          sum(rate(mutt_ingest_requests_total{status="success"}[5m]))
          /
          sum(rate(mutt_ingest_requests_total[5m]))

      - record: mutt:slo:ingestor_availability:1h
        expr: |
          sum(rate(mutt_ingest_requests_total{status="success"}[1h]))
          /
          sum(rate(mutt_ingest_requests_total[1h]))

      - record: mutt:slo:ingestor_availability:24h
        expr: |
          sum(rate(mutt_ingest_requests_total{status="success"}[24h]))
          /
          sum(rate(mutt_ingest_requests_total[24h]))

      # Ingestor latency P99 (Target: 500ms)
      - record: mutt:slo:ingestor_latency_p99:5m
        expr: |
          histogram_quantile(0.99,
            sum(rate(mutt_ingest_latency_seconds_bucket[5m])) by (le)
          )

      - record: mutt:slo:ingestor_latency_p99:1h
        expr: |
          histogram_quantile(0.99,
            sum(rate(mutt_ingest_latency_seconds_bucket[1h])) by (le)
          )

      - record: mutt:slo:ingestor_latency_p99:24h
        expr: |
          histogram_quantile(0.99,
            sum(rate(mutt_ingest_latency_seconds_bucket[24h])) by (le)
          )

      # ================================================================
      # Moog Forwarder SLO Recording Rules
      # ================================================================

      # Forwarder availability - success rate (Target: 99.5%)
      - record: mutt:slo:forwarder_availability:5m
        expr: |
          sum(rate(mutt_moog_requests_total{status="success"}[5m]))
          /
          sum(rate(mutt_moog_requests_total[5m]))

      - record: mutt:slo:forwarder_availability:1h
        expr: |
          sum(rate(mutt_moog_requests_total{status="success"}[1h]))
          /
          sum(rate(mutt_moog_requests_total[1h]))

      - record: mutt:slo:forwarder_availability:24h
        expr: |
          sum(rate(mutt_moog_requests_total{status="success"}[24h]))
          /
          sum(rate(mutt_moog_requests_total[24h]))

      # Forwarder latency P99 (Target: 2000ms)
      - record: mutt:slo:forwarder_latency_p99:5m
        expr: |
          histogram_quantile(0.99,
            sum(rate(mutt_moog_request_latency_seconds_bucket[5m])) by (le)
          )

      - record: mutt:slo:forwarder_latency_p99:1h
        expr: |
          histogram_quantile(0.99,
            sum(rate(mutt_moog_request_latency_seconds_bucket[1h])) by (le)
          )

      - record: mutt:slo:forwarder_latency_p99:24h
        expr: |
          histogram_quantile(0.99,
            sum(rate(mutt_moog_request_latency_seconds_bucket[24h])) by (le)
          )

      # ================================================================
      # Alerter SLO Recording Rules
      # ================================================================

      # Alerter processing success rate (Target: 99.9%)
      - record: mutt:slo:alerter_processing_success:5m
        expr: |
          sum(rate(mutt_alerter_events_processed_total{status="handled"}[5m]))
          /
          sum(rate(mutt_alerter_events_processed_total[5m]))

      - record: mutt:slo:alerter_processing_success:1h
        expr: |
          sum(rate(mutt_alerter_events_processed_total{status="handled"}[1h]))
          /
          sum(rate(mutt_alerter_events_processed_total[1h]))

      - record: mutt:slo:alerter_processing_success:24h
        expr: |
          sum(rate(mutt_alerter_events_processed_total{status="handled"}[24h]))
          /
          sum(rate(mutt_alerter_events_processed_total[24h]))

      # Alerter cache reload success (Target: 99%)
      - record: mutt:slo:alerter_cache_reload_success:5m
        expr: |
          (
            1 -
            (
              sum(rate(mutt_alerter_cache_reload_failures_total[5m]))
              /
              sum(rate(mutt_alerter_cache_reload_total[5m]))
            )
          )

      - record: mutt:slo:alerter_cache_reload_success:1h
        expr: |
          (
            1 -
            (
              sum(rate(mutt_alerter_cache_reload_failures_total[1h]))
              /
              sum(rate(mutt_alerter_cache_reload_total[1h]))
            )
          )

      - record: mutt:slo:alerter_cache_reload_success:24h
        expr: |
          (
            1 -
            (
              sum(rate(mutt_alerter_cache_reload_failures_total[24h]))
              /
              sum(rate(mutt_alerter_cache_reload_total[24h]))
            )
          )

      # ================================================================
      # SLO Burn Rate Calculations (for alerting)
      # ================================================================

      # Error budget burn rate for ingestor (1h window)
      - record: mutt:slo:ingestor_error_budget_burn_rate:1h
        expr: |
          (
            1 - mutt:slo:ingestor_availability:1h
          )
          /
          (1 - 0.999)

      # Error budget burn rate for forwarder (1h window)
      - record: mutt:slo:forwarder_error_budget_burn_rate:1h
        expr: |
          (
            1 - mutt:slo:forwarder_availability:1h
          )
          /
          (1 - 0.995)

      # Error budget burn rate for alerter (1h window)
      - record: mutt:slo:alerter_error_budget_burn_rate:1h
        expr: |
          (
            1 - mutt:slo:alerter_processing_success:1h
          )
          /
          (1 - 0.999)
